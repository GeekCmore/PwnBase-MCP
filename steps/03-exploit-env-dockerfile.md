# Step 03 — exploit-env Dockerfile & pyproject.toml

**Reference docs:** `docs/exploit-env.md`

**Docker required:** Yes — this step builds the exploit-env image.

---

## What to Build

The exploit-env container image and its Python project configuration. No Python source code yet — just the container and dependency setup.

---

## Files to Create

### `exploit-env/pyproject.toml`

```toml
[project]
name = "pwn-agent-mcp"
version = "0.1.0"
requires-python = ">=3.11"
dependencies = [
    "pwntools>=4.12.0",
    "mcp[cli]>=1.0.0",
    "httpx>=0.27.0",
    "flask>=3.0.0",
]

[project.optional-dependencies]
test = [
    "pytest>=8.0.0",
    "pytest-asyncio>=0.23.0",
    "pytest-mock>=3.12.0",
]

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[tool.pytest.ini_options]
asyncio_mode = "auto"
testpaths = ["../tests"]
```

### `exploit-env/mcp_server/__init__.py`

Empty file:
```python
```

### `exploit-env/Dockerfile`

```dockerfile
FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

# System dependencies
RUN apt-get update && apt-get install -y \
    python3 python3-pip python3-dev \
    gdb git curl wget \
    build-essential \
    procps \
    ruby \
    && rm -rf /var/lib/apt/lists/*

# Install pwndbg
RUN git clone https://github.com/pwndbg/pwndbg /opt/pwndbg \
 && cd /opt/pwndbg && ./setup.sh \
 && rm -rf /opt/pwndbg/.git

# Install uv
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="/root/.local/bin:$PATH"

WORKDIR /app

# Install Python dependencies
COPY pyproject.toml /app/pyproject.toml

# Create empty mcp_server package so uv sync succeeds before source is copied
RUN mkdir -p /app/mcp_server && touch /app/mcp_server/__init__.py

RUN uv sync

# Copy source (separate layer for faster rebuilds during development)
COPY mcp_server/ /app/mcp_server/

EXPOSE 8080

CMD ["uv", "run", "python", "-m", "mcp_server.main"]
```

---

## Create Empty Module Stubs

Create empty stub files for all modules so the package is importable (source will be filled in later steps):

```bash
for f in main session block_registry execution_engine interpreter \
          gdb_controller proc_utils challenge_client ghidra_proxy; do
    touch exploit-env/mcp_server/${f}.py
done
```

---

## Build Verification

### 1. Build the image
```bash
docker build -t exploit-env:latest exploit-env/
```
This will take several minutes the first time (pwndbg installation).

### 2. Verify pwndbg is installed
```bash
docker run --rm exploit-env:latest gdb --batch -ex "python import pwndbg; print('pwndbg OK')"
```
Expected output contains: `pwndbg OK`

### 3. Verify pwntools is importable
```bash
docker run --rm exploit-env:latest uv run python3 -c "from pwn import *; print('pwntools OK')"
```

### 4. Verify MCP SDK is importable
```bash
docker run --rm exploit-env:latest \
    uv run python3 -c "from mcp.server.fastmcp import FastMCP; print('MCP SDK OK')"
```

### 5. Verify uv is on PATH
```bash
docker run --rm exploit-env:latest uv --version
```

All checks must pass before proceeding to Step 04.
